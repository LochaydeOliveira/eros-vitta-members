<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Área de Membros - Eros Vitta</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; color: #0f172a; background: #f8fafc; }
    header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: #fff; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
    .btn { appearance: none; border: 0; background: #7c3aed; color: #fff; padding: 10px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .btn.secondary { background: #0ea5e9; }
    .btn.muted { background: #cbd5e1; color: #0f172a; cursor: not-allowed; }
    .input { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media(min-width: 640px){ .row { grid-template-columns: 1fr 1fr; } }
    .title { font-size: 18px; font-weight: 700; margin: 8px 0; }
    .muted { color: #475569; font-size: 14px; }
    .media { margin-top: 12px; }
    img.page { width: 100%; height: auto; border: 1px solid #e2e8f0; border-radius: 6px; background: #fff; }
    audio { width: 100%; margin-top: 8px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; align-items: center; }
    .pager { display: inline-flex; gap: 6px; align-items: center; }
    .small { font-size: 12px; }
    .tag { display: inline-block; font-size: 12px; padding: 2px 6px; border-radius: 999px; background: #e2e8f0; color: #0f172a; }
    /* Fullscreen modal */
    .overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.86); display: none; z-index: 1000; }
    .overlay.show { display: block; }
    .overlay-inner { position: absolute; inset: 0; display: grid; grid-template-rows: auto 1fr auto; }
    .overlay-toolbar { display:flex; gap:8px; align-items:center; justify-content: space-between; padding: 10px 12px; background: rgba(255,255,255,0.08); color: #fff; }
    .overlay-actions { display:flex; gap:8px; align-items:center; }
    .overlay-btn { appearance:none; border:1px solid #cbd5e1; background:#7c3aed; color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600; }
    .overlay-btn.ghost { background: transparent; border-color: #64748b; }
    .overlay-canvas { overflow:auto; display:flex; align-items:center; justify-content:center; padding: 12px; }
    .overlay img { max-width: 100%; height: auto; border-radius: 6px; background:#fff; }
    canvas.pdfpage { background:#fff; border-radius:6px; box-shadow: 0 0 0 1px #e2e8f0; }
  </style>
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configura worker do PDF.js
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
    const apiBase = location.origin;

    function setToken(token){ localStorage.setItem('ev_token', token); }
    function getToken(){ return localStorage.getItem('ev_token') || ''; }
    function clearToken(){ localStorage.removeItem('ev_token'); }

    let currentUserEmail = '';
    const pdfPageByProduct = {}; // produto_id -> página atual (int)
    const pdfZoomByProduct = {}; // produto_id -> largura solicitada

    async function api(path, opts={}){
      const token = getToken();
      const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
      if(token){ headers['Authorization'] = 'Bearer ' + token; }
      const res = await fetch(apiBase + path, Object.assign({}, opts, { headers }));
      if(!res.ok){
        let msg = 'Erro';
        try { const j = await res.json(); msg = j.error || JSON.stringify(j); } catch {}
        throw new Error(msg);
      }
      return res.json();
    }

    async function login(ev){
      ev.preventDefault();
      const email = document.querySelector('#email').value.trim().toLowerCase();
      const senha = document.querySelector('#senha').value;
      try {
        const j = await api('/api/auth/login', { method:'POST', body: JSON.stringify({ email, senha }) });
        setToken(j.data.token);
        document.querySelector('#login').style.display='none';
        document.querySelector('#app').style.display='block';
        document.querySelector('#userEmail').textContent = email;
        currentUserEmail = email;
        await loadCatalog();
      } catch(e){ alert('Falha no login: ' + e.message); }
    }

    async function logout(){ clearToken(); location.reload(); }

    async function loadCatalog(){
      const list = document.querySelector('#catalog');
      list.innerHTML = '<div class="muted">Carregando...</div>';
      try {
        const j = await api('/api/products');
        const items = j.data.items || [];
        if(items.length === 0){ list.innerHTML = '<div class="muted">Nenhum conteúdo liberado ainda.</div>'; return; }
        list.innerHTML = '';
        for(const it of items){ list.appendChild(renderItem(it)); }
      } catch(e){ list.innerHTML = '<div class="muted">Erro: '+e.message+'</div>'; }
    }

    function renderItem(it){
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="title">${escapeHtml(it.titulo)}</div>
        <div class="muted">Tipo: ${it.tipo === 'ebook' ? 'Ebook' : 'Áudio'} ${it.acesso_status ? '<span class="tag">'+it.acesso_status+'</span>' : ''}</div>
        <div class="actions"></div>
        <div class="media" id="media-${it.id}"></div>
      `;
      const actions = el.querySelector('.actions');
      if(it.tipo === 'ebook'){
        const btnPdf = button('Ler agora', async ()=>{ openPdfReader(it.id); });
        actions.appendChild(btnPdf);
      } else {
        const btnPlay = button('Ouvir', async ()=>{ await playAudio(it.id); });
        actions.appendChild(btnPlay);
      }
      const canDownload = Number(it.download_liberado) === 1;
      const btnDl = button('Download', async ()=>{ await doDownload(it.id); });
      if(!canDownload){ btnDl.classList.add('muted'); btnDl.disabled = true; btnDl.textContent = 'Download (bloqueado até D+7)'; }
      actions.appendChild(btnDl);
      return el;
    }

    function button(text, onClick){ const b = document.createElement('button'); b.className='btn'; b.textContent = text; b.onclick = onClick; return b; }

    function renderPager(produtoId, actionsEl){
      let pager = actionsEl.querySelector('.pager');
      if(!pager){
        pager = document.createElement('div');
        pager.className = 'pager';
        const prev = button('Anterior', async ()=>{
          const p = Math.max(1, (pdfPageByProduct[produtoId]||1) - 1);
          pdfPageByProduct[produtoId] = p;
          await showPdfPage(produtoId, p, {silent404:false, dir:-1});
        });
        const next = button('Próxima', async ()=>{
          const p = (pdfPageByProduct[produtoId]||1) + 1;
          pdfPageByProduct[produtoId] = p;
          await showPdfPage(produtoId, p, {silent404:false, dir:+1});
        });
        const label = document.createElement('span');
        label.className = 'small';
        label.id = `pager-label-${produtoId}`;
        label.textContent = 'Página 1';
        pager.appendChild(prev);
        pager.appendChild(next);
        pager.appendChild(label);
        actionsEl.appendChild(pager);
      }
    }

    async function showPdfPage(produtoId, page, opts={silent404:true, dir:0}){
      const token = getToken();
      const width = pdfZoomByProduct[produtoId] || 1200;
      const url = apiBase + `/api/view/pdf?produto_id=${encodeURIComponent(produtoId)}&page=${encodeURIComponent(page)}&width=${encodeURIComponent(width)}`;
      const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
      if(!res.ok){
        if(res.status === 404 && opts.silent404 && opts.dir === -1){
          // tentou página anterior inexistente: trava em 1
          pdfPageByProduct[produtoId] = 1;
          return;
        }
        if(res.status === 404 && !opts.silent404 && opts.dir === +1){
          // última página atingida: volta uma
          pdfPageByProduct[produtoId] = Math.max(1, page-1);
          alert('Última página alcançada.');
          return;
        }
        alert('Erro ao carregar página');
        return;
      }
      const blob = await res.blob();
      const imgUrl = URL.createObjectURL(blob);
      const media = document.querySelector(`#media-${produtoId}`);
      media.innerHTML = '';
      const img = document.createElement('img');
      img.className = 'page';
      img.src = imgUrl;
      media.appendChild(img);
      pdfPageByProduct[produtoId] = page;
      const label = document.querySelector(`#pager-label-${produtoId}`);
      if(label) label.textContent = `Página ${page}`;
    }

    // PDF.js reader (sem botões de download/impressão)
    function ensurePdfReader(){
      let ov = document.querySelector('#pdf-reader');
      if(ov) return ov;
      ov = document.createElement('div');
      ov.className = 'overlay';
      ov.id = 'pdf-reader';
      ov.innerHTML = `
        <div class="overlay-inner">
          <div class="overlay-toolbar">
            <div class="overlay-actions">
              <button class="overlay-btn ghost" id="pr-close">Fechar</button>
              <button class="overlay-btn ghost" id="pr-fs">Tela cheia</button>
            </div>
            <div class="overlay-actions">
              <button class="overlay-btn" id="pr-prev">Anterior</button>
              <button class="overlay-btn" id="pr-next">Próxima</button>
              <button class="overlay-btn ghost" id="pr-zoom-out">-</button>
              <span id="pr-zoom-label" class="small">100%</span>
              <button class="overlay-btn ghost" id="pr-zoom-in">+</button>
            </div>
          </div>
          <div class="overlay-canvas"><canvas id="pr-canvas" class="pdfpage"></canvas></div>
          <div class="overlay-toolbar" style="justify-content:center"><span id="pr-page" class="small">Página 1</span></div>
        </div>`;
      document.body.appendChild(ov);
      ov.querySelector('#pr-close').addEventListener('click', ()=> ov.classList.remove('show'));
      ov.querySelector('#pr-fs').addEventListener('click', async ()=>{
        const el = document.documentElement; try { await (el.requestFullscreen ? el.requestFullscreen() : (el.webkitRequestFullscreen&&el.webkitRequestFullscreen())); } catch {}
      });
      return ov;
    }

    async function openPdfReader(produtoId){
      if(!window['pdfjsLib']){ alert('Visualizador PDF indisponível.'); return; }
      const ov = ensurePdfReader();
      ov.classList.add('show');
      const token = getToken();
      // carrega o PDF como ArrayBuffer
      const res = await fetch(`/api/view/pdf-file?produto_id=${encodeURIComponent(produtoId)}`, { headers: { 'Authorization': 'Bearer ' + token } });
      if(!res.ok){ alert('Falha ao carregar PDF'); return; }
      const buf = await res.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      let pageNum = 1; let scale = 1.2;
      const canvas = document.getElementById('pr-canvas');
      const ctx = canvas.getContext('2d');
      const lblPage = document.getElementById('pr-page');
      const lblZoom = document.getElementById('pr-zoom-label');
      async function render(){
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale });
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        lblPage.textContent = `Página ${pageNum} / ${pdf.numPages}`;
        lblZoom.textContent = Math.round(scale*100) + '%';
      }
      document.getElementById('pr-prev').onclick = async ()=>{ pageNum = Math.max(1, pageNum-1); await render(); };
      document.getElementById('pr-next').onclick = async ()=>{ pageNum = Math.min(pdf.numPages, pageNum+1); await render(); };
      document.getElementById('pr-zoom-in').onclick = async ()=>{ scale = Math.min(3.0, scale+0.1); await render(); };
      document.getElementById('pr-zoom-out').onclick = async ()=>{ scale = Math.max(0.6, scale-0.1); await render(); };
      await render();
    }

    async function playAudio(produtoId){
      const token = getToken();
      const url = apiBase + `/api/view/audio?produto_id=${encodeURIComponent(produtoId)}`;
      const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
      if(!res.ok){ alert('Erro ao carregar áudio'); return; }
      const blob = await res.blob();
      const audioUrl = URL.createObjectURL(blob);
      const media = document.querySelector(`#media-${produtoId}`);
      media.innerHTML = '';
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.src = audioUrl;
      media.appendChild(audio);
      try {
        const key = `ev_audio_pos_${currentUserEmail}_${produtoId}`;
        const saved = parseFloat(localStorage.getItem(key) || '0');
        if(!isNaN(saved) && saved > 0){ audio.currentTime = saved; }
        audio.addEventListener('timeupdate', ()=>{
          try { localStorage.setItem(key, String(audio.currentTime||0)); } catch {}
        });
        audio.addEventListener('ended', ()=>{
          try { localStorage.removeItem(key); } catch {}
        });
        audio.play().catch(()=>{});
      } catch {}
    }

    async function doDownload(produtoId){
      try {
        const j = await api('/api/downloads/token', { method:'POST', body: JSON.stringify({ produto_id: produtoId }) });
        const t = j.data.token;
        window.location.href = `/api/downloads/file?token=${encodeURIComponent(t)}`;
      } catch(e){ alert('Download indisponível: ' + e.message); }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    window.addEventListener('DOMContentLoaded', ()=>{
      const has = !!getToken();
      document.querySelector('#login').style.display = has ? 'none' : 'block';
      document.querySelector('#app').style.display = has ? 'block' : 'none';
      if(has){ loadCatalog(); }
    });
  </script>
  </head>
<body>
  <header>
    <div><strong>Eros Vitta Members</strong></div>
    <div>
      <span class="muted" id="userEmail"></span>
      <button class="btn secondary" onclick="logout()">Sair</button>
    </div>
  </header>

  <main class="container">
    <section id="login" class="card" style="display:none">
      <h2>Entrar</h2>
      <form onsubmit="login(event)">
        <div class="row">
          <div><label class="muted">E-mail</label><input id="email" class="input" type="email" required /></div>
          <div><label class="muted">Senha</label><input id="senha" class="input" type="password" required /></div>
        </div>
        <div style="margin-top:12px"><button class="btn" type="submit">Entrar</button></div>
      </form>
    </section>

    <section id="app" style="display:none">
      <h2>Catálogo</h2>
      <div id="catalog" class="grid"></div>
    </section>
  </main>
  <!-- PDF.js iframe modal simples -->
  <div id="pdfjs-modal" class="overlay"><div class="overlay-inner">
    <div class="overlay-toolbar"><div></div><div class="overlay-actions"><button class="overlay-btn ghost" onclick="document.getElementById('pdfjs-modal').classList.remove('show')">Fechar</button></div></div>
    <div class="overlay-canvas"><iframe id="pdfjs-frame" style="width:100%;height:100%;border:0;background:#fff"></iframe></div>
    <div class="overlay-toolbar" style="justify-content:center"><span class="small">Visualização PDF</span></div>
  </div></div>
  <script>
    function openPdfJs(produtoId){
      const token = getToken();
      const src = `/api/view/pdf-file?produto_id=${encodeURIComponent(produtoId)}`;
      const iframe = document.getElementById('pdfjs-frame');
      // Usa viewer nativo do navegador (iframe) com Authorization não suportado → solução: window.open com Bearer no header não é possível.
      // Alternativa: URL temporária com token de sessão no query (não ideal). Como estamos atrás de JWT no backend, usamos fetch+blob.
      fetch(src, { headers: { 'Authorization': 'Bearer ' + token } })
        .then(r => { if(!r.ok) throw new Error('Falha ao carregar PDF'); return r.blob(); })
        .then(b => {
          const url = URL.createObjectURL(b);
          iframe.src = url; // navegador abrirá o PDF com suas ferramentas (zoom, páginas, imprimir)
          document.getElementById('pdfjs-modal').classList.add('show');
        })
        .catch(e => alert(e.message));
    }
  </script>
</body>
</html>


