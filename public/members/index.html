<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eros Vitta - Área de Membros</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root { 
      --bg:#f8f2ed; 
      --surface:#ffffff; 
      --border:#e5e7eb; 
      --text:#a16f52; 
      --muted:#64748b; 
      --radius:6px; 
      --radius-lg:6px;
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      color: var(--text);
      background: var(--bg);
      font-size: 15px;
    }
    header { display: none; align-items: center; justify-content: space-between; padding: 12px 16px; background: #fff; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
    @media(max-width: 640px){ header { padding: 10px 12px; } }
    .header-title { display: flex; align-items: center; gap: 8px; font-weight: 700; }
    .header-actions { display: flex; align-items: center; gap: 12px; }
    .layout {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      min-height: 100vh;
      box-sizing: border-box;
      justify-content: center;
      align-content: center;
      flex-wrap: wrap;
    }
    @media(max-width: 900px){ .layout { padding: 16px; } }
    @media(max-width: 640px){ .layout { padding: 12px; } }
    .sidebar { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:12px; height: fit-content; position: sticky; top: 64px; }
    .sidebar h3 { font-size:14px; color:#475569; margin:8px 8px 6px; text-transform: uppercase; letter-spacing: .02em; }
    .side-link { display:flex; align-items:center; gap:8px; padding:10px 12px; color:#0f172a; text-decoration:none; border-radius:8px; }
    .side-link:hover { background:#f1f5f9; }
    .icon { width:18px; height:18px; display:inline-block; color:#475569; }
    .container {
      padding: 0;
    }

    .container-login {
      padding: 0;
      width: 100%;
      max-width: 400px;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: 0 4px 16px rgba(15,23,42,0.04);
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 300px;
      transition: all 0.2s ease;
    }

    .badge-lock,
.btn.secondary {
  position: relative; /* ou absolute, se quiser fixar em um ponto específico */
  z-index: 9999;      /* bem alto para garantir que fique no topo */
}

/* Se quiser posicionar o badge no canto superior direito da .card */
.card .badge-lock {
  position: absolute;
  top: 8px;
  right: 8px;
  background: rgba(0, 0, 0, 0.7);
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
}

    @media(max-width: 480px){ .card { min-height: 280px; padding: 14px; } }
    .card:hover { box-shadow: 0 8px 24px rgba(15,23,42,0.08); transform: translateY(-1px); }
    .card.blocked {
      opacity: .55;
      filter: grayscale(85%);
    }
    .badge-lock { position:absolute; top:10px; right:10px; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; border-radius:999px; padding:2px 8px; font-size:11px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    @media(max-width: 640px){ .grid { gap: 12px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); } }
    @media(max-width: 480px){ .grid { gap: 10px; grid-template-columns: 1fr; } }
    .btn {
      appearance: none;
      border: 0;
      background: #a16f52;
      color: #fff;
      padding: 8px 12px;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      height: 36px;
      font-size: 14px;
      width: 100%;
      text-align: center;
      transition: all 0.2s ease;
    }
    .btn:hover { background: #1f2937; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.secondary { background: #0ea5e9; max-height: max-content; }
    .btn.secondary:hover { background: #0284c7; }
    .btn.muted { background: #cbd5e1; color: #0f172a; cursor: not-allowed; }
    .btn.muted:hover { background: #cbd5e1; transform: none; }
    .input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius); background:#fff; box-sizing: border-box; height: 44px; font-size: 14px; transition: all 0.2s ease; }
    .input:focus { outline: 2px solid #0ea5e9; outline-offset: 0; border-color: #0ea5e9; }
    .row { display: grid; grid-template-columns: 1fr; gap: 10px; }
    /* Forçar uma coluna em qualquer largura */
    @media(min-width: 640px){ .row { grid-template-columns: 1fr; } }
    .title { font-size: 16px; font-weight: 700; margin: 6px 0; line-height: 1.3; }
    .muted { color: #475569; font-size: 12px; margin: 4px 0; line-height: 1.4; }
    .media { margin-top: 10px; }
    img.page { width: 100%; height: auto; border: 1px solid #e2e8f0; border-radius: 6px; background: #fff; }
    audio { width: 100%; margin-top: 8px; }
    .actions { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; align-items: center; }
    @media(max-width: 480px){ .actions { gap: 4px; } }
    .pager { display: inline-flex; gap: 6px; align-items: center; }
    .small { font-size: 11px; }
    .tag { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 999px; background: #e2e8f0; color: #0f172a; font-weight: 500; }
    .tag.ok { background: #dcfce7; color: #166534; }
    .tag.blocked { background: #fee2e2; color: #991b1b; }
    .thumb { width: 100%; height: auto; border: 0; border-radius: var(--radius); background: #fff; object-fit: cover; aspect-ratio: 3 / 4; }
    .thumb.ph { display:flex; align-items:center; justify-content:center; color:#64748b; font-weight:700; }
    /* Ícones Font Awesome */
    .fas, .far, .fab { margin-right: 6px; }
    .btn i { margin-right: 6px; }
    .tag i { margin-right: 4px; }
    .menu-item i { margin-right: 8px; }
    /* Avatar + menu */
    .avatar { width: 36px; height: 36px; border-radius: 999px; background:#111827; color:#fff; display:inline-flex; align-items:center; justify-content:center; font-weight:700; cursor: pointer; }
    .menu { position: relative; }
    .menu-panel { position:absolute; right:0; top:44px; background:var(--surface); border:1px solid var(--border); border-radius:12px; box-shadow: 0 14px 34px rgba(15,23,42,.10); min-width: 220px; display:none; overflow:hidden; }
    .menu-panel.open { display:block; }
    .menu-header { padding:12px 14px; border-bottom:1px solid var(--border); }
    .menu-item { display:block; width:100%; text-align:left; padding:10px 12px; background:var(--surface); border:0; cursor:pointer; }
    .menu-item:hover { background:#f1f5f9; }
    /* Forms */
    label { display:block; margin: 4px 0 6px; font-size:13px; color:#475569; }

    .form-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .form-card { width:100%; max-width: 900px; margin: 0 auto; }
    .form-card .row { gap: 12px; }
    .input:focus { outline: 2px solid #0ea5e9; outline-offset: 0; }
    
    /* Micro-ajustes finais */
    .badge-lock { font-size: 10px; padding: 2px 6px; }
    .thumb.ph { font-size: 13px; }
    .pager { gap: 4px; }
    .small { font-size: 10px; line-height: 1.3; }
    
    /* Melhorias de acessibilidade */
    .btn:focus-visible { outline: 2px solid #0ea5e9; outline-offset: 2px; }
    .card:focus-within { outline: 2px solid #0ea5e9; outline-offset: 2px; }
    /* Auth (estilo Yampi-like) */
    .auth-card {
      max-width: 548px;
      padding: 8rem 2rem;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }
    .auth-title { font-size: 26px; line-height: 1.2; margin: 4px 0 4px; text-align:center; font-weight:700; }
    .auth-subtitle { text-align:center; margin: 0 0 16px; color:#64748b; }
    .auth-card .input { background:#f8fbff; }
    .link { color:#111827; text-decoration:none; font-size:13px; }
    .link:hover { text-decoration:underline; }
    .text-right { text-align:right; }
    .btn.block { width:100%; }
    /* Bloqueio de seleção global (inputs continuam permitidos) */
    body { -webkit-user-select: none; user-select: none; }
    input, textarea { -webkit-user-select: text; user-select: text; }
    /* Fullscreen modal */
    .overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.86); display: none; z-index: 1000; }
    .overlay.show { display: block; }
    .overlay-inner { position: absolute; inset: 0; display: grid; grid-template-rows: auto 1fr auto; }
    .overlay-toolbar { display:flex; gap:8px; align-items:center; justify-content: space-between; padding: 10px 12px; background: rgba(255,255,255,0.08); color: #fff; }
    .overlay-actions { display:flex; gap:8px; align-items:center; }
    .overlay-btn { appearance:none; border:1px solid #cbd5e1; background:#111827; color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600; }
    .overlay-btn.ghost { background: transparent; border-color: #64748b; }
    .overlay-canvas { overflow:auto; display:flex; align-items:center; justify-content:center; padding: 12px; }
    .overlay img { max-width: 100%; height: auto; border-radius: 6px; background:#fff; }
    canvas.pdfpage { background:#fff; border-radius:6px; box-shadow: 0 0 0 1px #e2e8f0; }
    /* Player progresso */
    .progress { height: 8px; background:#e2e8f0; border-radius:999px; position:relative; cursor:pointer; margin-top:8px; }
    .progress .bar { height:100%; background:#111827; width:0%; border-radius:999px; }
    .time { margin-top:6px; color:#475569; }
  </style>
  <style>
    /* Toasts leves (não intrusivos) */
    #toast { position: fixed; right: 16px; bottom: 16px; z-index: 2000; max-width: 360px; display:none; }
    #toast .tcard { background:#111827; color:#fff; padding:10px 12px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,.25); font-size:14px; }
    #toast.ok .tcard { background:#065f46; }
    #toast.warn .tcard { background:#7c2d12; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script>
    function openForgot(){
      let modal = document.getElementById('forgot-modal');
      if(!modal){
        modal = document.createElement('div');
        modal.className = 'overlay';
        modal.id = 'forgot-modal';
        modal.innerHTML = `
          <div class="overlay-inner">
            <div class="overlay-toolbar">
              <div class="overlay-actions"><button class="overlay-btn ghost" id="fg-close">Fechar</button></div>
              <div class="overlay-actions"><span class="small">Recuperar senha</span></div>
            </div>
            <div class="overlay-canvas">
              <div class="card form-card">
                <h3 class="title">Recuperar senha</h3>
                <div class="row">
                  <div><label class="muted" for="fg-email">E-mail</label><input id="fg-email" class="input" type="email" placeholder="seu@email.com" autocomplete="email" required /></div>
                </div>
                <div class="form-actions">
                  <button class="btn secondary" id="fg-send">Enviar</button>
                </div>
                <div class="small" id="fg-msg" style="margin-top:8px"></div>
              </div>
            </div>
            <div class="overlay-toolbar" style="justify-content:center"><span class="small">Suporte</span></div>
          </div>`;
        document.body.appendChild(modal);
        modal.querySelector('#fg-close').addEventListener('click', ()=> modal.classList.remove('show'));
        modal.querySelector('#fg-send').addEventListener('click', async ()=>{
          const email = (document.getElementById('fg-email').value||'').trim().toLowerCase();
          const msg = document.getElementById('fg-msg');
          if(!email){ msg.textContent = 'Informe seu e-mail.'; return; }
          msg.textContent = 'Enviando...';
          try{
            const res = await api('/api/auth/password/forgot', { method:'POST', body: JSON.stringify({ email }) });
            msg.textContent = (res && res.message) ? res.message : 'Se existir, um e-mail será enviado.';
          }catch(e){ msg.textContent = 'Falha: ' + e.message; }
        });
      }
      modal.classList.add('show');
    }

    function showToast(msg, type){
      const box = document.getElementById('toast');
      const m = document.getElementById('toast-msg');
      if(!box || !m){ alert(msg); return; }
      m.textContent = msg;
      box.className = type ? type : '';
      box.style.display = 'block';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>{ box.style.display='none'; }, 3500);
    }

    function openRegister(){ showToast('Cadastro via webhook / admin. Registro manual opcional.', 'warn'); }

    function openReset(prefillToken){
      let modal = document.getElementById('reset-modal');
      if(!modal){
        modal = document.createElement('div');
        modal.className = 'overlay';
        modal.id = 'reset-modal';
        modal.innerHTML = `
          <div class="overlay-inner">
            <div class="overlay-toolbar">
              <div class="overlay-actions"><button class="overlay-btn ghost" id="rs-close">Fechar</button></div>
              <div class="overlay-actions"><span class="small">Redefinir senha</span></div>
            </div>
            <div class="overlay-canvas">
              <div class="card form-card">
                <h3 class="title">Defina uma nova senha</h3>
                <div class="row">
                  <div><label class="muted" for="rs-token">Token</label><input id="rs-token" class="input" type="text" placeholder="cole aqui o token" autocomplete="one-time-code" required /></div>
                  <div><label class="muted" for="rs-new">Nova senha</label><input id="rs-new" class="input" type="password" placeholder="mínimo 6 caracteres" autocomplete="new-password" required /></div>
                  <div><label class="muted" for="rs-confirm">Confirmar senha</label><input id="rs-confirm" class="input" type="password" autocomplete="new-password" required /></div>
                </div>
                <div class="form-actions">
                  <button class="btn secondary" id="rs-send">Salvar</button>
                </div>
                <div class="small" id="rs-msg" style="margin-top:8px"></div>
              </div>
            </div>
            <div class="overlay-toolbar" style="justify-content:center"><span class="small">Segurança</span></div>
          </div>`;
        document.body.appendChild(modal);
        modal.querySelector('#rs-close').addEventListener('click', ()=> modal.classList.remove('show'));
        modal.querySelector('#rs-send').addEventListener('click', async ()=>{
          const token = (document.getElementById('rs-token').value||'').trim();
          const senha = (document.getElementById('rs-new').value||'');
          const confirm = (document.getElementById('rs-confirm').value||'');
          const msg = document.getElementById('rs-msg');
          if (!token){ msg.textContent = 'Informe o token.'; return; }
          if (!senha || senha.length < 6){ msg.textContent = 'Senha muito curta (mínimo 6).'; return; }
          if (senha !== confirm){ msg.textContent = 'As senhas não conferem.'; return; }
          msg.textContent = 'Enviando...';
          try{
            const res = await api('/api/auth/password/reset', { method:'POST', body: JSON.stringify({ token, senha }) });
            msg.textContent = (res && res.message) ? res.message : 'Senha atualizada.';
          }catch(e){ msg.textContent = 'Falha: ' + e.message; }
        });
      }
      modal.classList.add('show');
      if (prefillToken){ const t = document.getElementById('rs-token'); if (t) t.value = prefillToken; }
    }
    // Menu helpers (definido antes do restante para evitar ReferenceError)
    function toggleMenu(force){
      const p = document.getElementById('userMenu');
      const btn = document.getElementById('avatarBtn');
      if (!p || !btn) return;
      const open = typeof force === 'boolean' ? force : !p.classList.contains('open');
      if (open){ p.classList.add('open'); btn.setAttribute('aria-expanded','true'); }
      else { p.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
    }
    document.addEventListener('click', (e)=>{
      const p = document.getElementById('userMenu');
      const btn = document.getElementById('avatarBtn');
      if (!p || !btn) return;
      if (btn.contains(e.target)){ toggleMenu(); return; }
      if (!p.contains(e.target)){ p.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
    });
    // Configura worker do PDF.js
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
    const apiBase = location.origin;

    function setToken(token){ localStorage.setItem('ev_token', token); }
    function getToken(){ return localStorage.getItem('ev_token') || ''; }
    function clearToken(){ localStorage.removeItem('ev_token'); }

    let currentUserEmail = '';
    const pdfPageByProduct = {}; // produto_id -> página atual (int)
    const pdfZoomByProduct = {}; // produto_id -> largura solicitada

    async function api(path, opts={}){
      const token = getToken();
      const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
      if(token){ headers['Authorization'] = 'Bearer ' + token; }
      let url = apiBase + path;
      const method = (opts.method||'GET').toUpperCase();
      if(method === 'GET'){
        const sep = url.includes('?') ? '&' : '?';
        url = url + sep + '_ts=' + Date.now();
      }
      const res = await fetch(url, Object.assign({}, opts, { headers, cache: 'no-store' }));
      if(!res.ok){
        let msg = 'Erro';
        try { const j = await res.json(); msg = j.error || JSON.stringify(j); } catch {}
        throw new Error(msg);
      }
      return res.json();
    }

    async function login(ev){
      ev.preventDefault();
      const email = document.querySelector('#email').value.trim().toLowerCase();
      const senha = document.querySelector('#senha').value;
      try {
        const j = await api('/api/auth/login', { method:'POST', body: JSON.stringify({ email, senha }) });
        setToken(j.data.token);
        document.querySelector('#login').style.display='none';
        document.querySelector('#app').style.display='block';
        document.querySelector('header').style.display='flex'; // Mostrar header após login
        await loadUserProfile();
        currentUserEmail = email;
        await loadCatalog();
      } catch(e){ showToast('Falha no login: ' + e.message, 'warn'); }
    }

    async function logout(){ 
      clearToken(); 
      document.querySelector('header').style.display='none'; // Esconder header no logout
      location.reload(); 
    }

    // Acessos (exemplo simples)
    async function loadAccesses(){
      setHeader('Início / Meus acessos', 'Meus acessos');
      const list = document.querySelector('#catalog');
      list.innerHTML = '<div class="muted">Carregando acessos...</div>';
      try {
        const j = await api('/api/accesses');
        const items = j.data.items || [];
        list.innerHTML = '<h3 class="title">Meus acessos</h3>' + (items.length ? '' : '<div class="muted">Nenhum acesso ativo.</div>');
      } catch(e){ list.innerHTML = '<div class="muted">Erro: '+e.message+'</div>'; }
    }

    function openHelp(){ setHeader('Início / Ajuda', 'Ajuda'); showToast('Em breve: FAQ e suporte.', ''); }

    function setHeader(path, title){
      const sh = document.getElementById('sectionHeader'); if (sh) sh.style.display = 'block';
      const bc = document.getElementById('breadcrumbs'); if (bc) bc.textContent = path;
      const st = document.getElementById('sectionTitle'); if (st) st.textContent = title;
    }

    async function loadUserProfile(){
      try{
        const me = await api('/api/auth/me');
        const nameEl = document.querySelector('#userName');
        if (me.data && me.data.user){
          const u = me.data.user;
          const nome = u.nome || u.email || '';
          nameEl.textContent = nome;
          const ab = document.getElementById('avatarBtn');
          if (ab){
            const ini = (nome||'E V').trim().split(/\s+/).slice(0,2).map(s=>s[0]).join('').toUpperCase();
            ab.textContent = ini || 'EV';
          }
          if (!currentUserEmail) currentUserEmail = u.email || '';
        }
      }catch{}
    }

    async function loadCatalog(){
      const list = document.querySelector('#catalog');
      list.innerHTML = '<div class="muted">Carregando...</div>';
      try {
        const j = await api('/api/products');
        const items = j.data.items || [];
        if(items.length === 0){ list.innerHTML = '<div class="muted">Nenhum conteúdo disponível no momento.</div>'; return; }
        list.innerHTML = '';
        for(const it of items){ list.appendChild(renderItem(it)); }
      } catch(e){ list.innerHTML = '<div class="muted">Erro: '+e.message+'</div>'; }
      setHeader('Início / Catálogo', 'Catálogo');
    }

    function renderItem(it){
      const el = document.createElement('div');
      const hasAccess = (it.acesso_status === 'ativo');
      el.className = 'card' + (hasAccess ? '' : ' blocked');
      let cover = (typeof it.capa_url === 'string' && it.capa_url.trim() !== '') ? it.capa_url.trim() : '';
      if(cover && !/^https?:\/\//i.test(cover) && !cover.startsWith('/')){
        cover = '/' + cover; // normaliza relativo
      }
      const coverHtml = cover ? `<img class="thumb" src="${cover}" alt="${escapeHtml(it.titulo)}" loading="lazy" onerror="this.onerror=null;this.classList.add('ph');this.removeAttribute('src');this.textContent='Sem capa';" />` : `<div class="thumb ph">Sem capa</div>`;
      
      el.innerHTML = `
        ${coverHtml}
        <div class="title">${escapeHtml(it.titulo)}</div>
        <div class="muted">
          <i class="fas fa-${it.tipo === 'ebook' ? 'file-pdf' : 'music'}"></i>
          ${it.tipo === 'ebook' ? 'Ebook' : 'Áudio'} 
          ${hasAccess ? '<span class="tag ok"><i class="fas fa-check"></i> liberado</span>' : '<span class="tag blocked"><i class="fas fa-lock"></i> bloqueado</span>'}
        </div>
        <div class="actions"></div>
        <div class="media" id="media-${it.id}"></div>
      `;
      const actions = el.querySelector('.actions');
      if(hasAccess){
        if(it.tipo === 'ebook'){
          const btnPdf = document.createElement('button');
          btnPdf.className = 'btn';
          btnPdf.innerHTML = '<i class="fas fa-book-open"></i> Ler agora';
          btnPdf.onclick = async ()=>{ openPdfReader(it.id); };
          actions.appendChild(btnPdf);
        } else {
          const btnPlay = document.createElement('button');
          btnPlay.className = 'btn';
          btnPlay.innerHTML = '<i class="fas fa-play"></i> Ouvir álbum';
          btnPlay.onclick = async ()=>{ await playAudio(it.id, it.titulo || 'Álbum'); };
          actions.appendChild(btnPlay);
        }
      } else {
        const btnBuy = document.createElement('a');
        btnBuy.className = 'btn secondary';
        const custom = (it.checkout_url||'').trim();
        const pid = (it.hotmart_product_id||'').trim();
        const checkout = custom ? custom : (pid ? `https://pay.hotmart.com/${encodeURIComponent(pid)}` : '#');
        btnBuy.href = checkout;
        btnBuy.target = '_blank';
        btnBuy.rel = 'noopener';
        btnBuy.innerHTML = '<i class="fas fa-shopping-cart"></i> Comprar e Liberar';
        actions.appendChild(btnBuy);
        const lock = document.createElement('div'); lock.className='badge-lock'; lock.innerHTML='<i class="fas fa-lock"></i> Bloqueado'; el.appendChild(lock);
      }
      // Download removido da área de membros (entrega pós D+7 por e-mail)
      return el;
    }

    function button(text, onClick){ const b = document.createElement('button'); b.className='btn'; b.textContent = text; b.onclick = onClick; return b; }
    function formatDuration(seconds){
      const s = parseInt(seconds, 10);
      if (isNaN(s) || s <= 0) return '';
      const m = Math.floor(s / 60);
      const r = s % 60;
      return `${m}:${String(r).padStart(2,'0')}`;
    }

    function renderPager(produtoId, actionsEl){
      let pager = actionsEl.querySelector('.pager');
      if(!pager){
        pager = document.createElement('div');
        pager.className = 'pager';
        const prev = button('Anterior', async ()=>{
          const p = Math.max(1, (pdfPageByProduct[produtoId]||1) - 1);
          pdfPageByProduct[produtoId] = p;
          await showPdfPage(produtoId, p, {silent404:false, dir:-1});
        });
        const next = button('Próxima', async ()=>{
          const p = (pdfPageByProduct[produtoId]||1) + 1;
          pdfPageByProduct[produtoId] = p;
          await showPdfPage(produtoId, p, {silent404:false, dir:+1});
        });
        const label = document.createElement('span');
        label.className = 'small';
        label.id = `pager-label-${produtoId}`;
        label.textContent = 'Página 1';
        pager.appendChild(prev);
        pager.appendChild(next);
        pager.appendChild(label);
        actionsEl.appendChild(pager);
      }
    }

    async function showPdfPage(produtoId, page, opts={silent404:true, dir:0}){
      const token = getToken();
      const width = pdfZoomByProduct[produtoId] || 1200;
      const url = apiBase + `/api/view/pdf?produto_id=${encodeURIComponent(produtoId)}&page=${encodeURIComponent(page)}&width=${encodeURIComponent(width)}`;
      const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
      if(!res.ok){
        if(res.status === 404 && opts.silent404 && opts.dir === -1){
          // tentou página anterior inexistente: trava em 1
          pdfPageByProduct[produtoId] = 1;
          return;
        }
        if(res.status === 404 && !opts.silent404 && opts.dir === +1){
          // última página atingida: volta uma
          pdfPageByProduct[produtoId] = Math.max(1, page-1);
          showToast('Última página alcançada.', '');
          return;
        }
        if(res.status === 403){ showToast('Acesso bloqueado para este conteúdo.', 'warn'); return; }
        showToast('Erro ao carregar página', 'warn');
        return;
      }
      const blob = await res.blob();
      const imgUrl = URL.createObjectURL(blob);
      const media = document.querySelector(`#media-${produtoId}`);
      media.innerHTML = '';
      const img = document.createElement('img');
      img.className = 'page';
      img.src = imgUrl;
      media.appendChild(img);
      pdfPageByProduct[produtoId] = page;
      const label = document.querySelector(`#pager-label-${produtoId}`);
      if(label) label.textContent = `Página ${page}`;
    }

    // PDF.js reader (sem botões de download/impressão)
    function ensurePdfReader(){
      let ov = document.querySelector('#pdf-reader');
      if(ov) return ov;
      ov = document.createElement('div');
      ov.className = 'overlay';
      ov.id = 'pdf-reader';
      ov.innerHTML = `
        <div class="overlay-inner">
          <div class="overlay-toolbar">
            <div class="overlay-actions">
              <button class="overlay-btn ghost" id="pr-close">Fechar</button>
              <button class="overlay-btn ghost" id="pr-fs">Tela cheia</button>
            </div>
            <div class="overlay-actions">
              <button class="overlay-btn" id="pr-prev">Anterior</button>
              <button class="overlay-btn" id="pr-next">Próxima</button>
              <button class="overlay-btn ghost" id="pr-zoom-out">-</button>
              <span id="pr-zoom-label" class="small">100%</span>
              <button class="overlay-btn ghost" id="pr-zoom-in">+</button>
            </div>
          </div>
          <div class="overlay-canvas"><canvas id="pr-canvas" class="pdfpage"></canvas></div>
          <div class="overlay-toolbar" style="justify-content:center"><span id="pr-page" class="small">Página 1</span></div>
        </div>`;
      document.body.appendChild(ov);
      ov.querySelector('#pr-close').addEventListener('click', ()=> ov.classList.remove('show'));
      ov.querySelector('#pr-fs').addEventListener('click', async ()=>{
        const el = document.documentElement; try { await (el.requestFullscreen ? el.requestFullscreen() : (el.webkitRequestFullscreen&&el.webkitRequestFullscreen())); } catch {}
      });
      return ov;
    }

    async function openPdfReader(produtoId){
      if(!window['pdfjsLib']){ showToast('Visualizador PDF indisponível.', 'warn'); return; }
      const ov = ensurePdfReader();
      ov.classList.add('show');
      const token = getToken();
      // carrega o PDF como ArrayBuffer
      const res = await fetch(`/api/view/pdf-file?produto_id=${encodeURIComponent(produtoId)}`, { headers: { 'Authorization': 'Bearer ' + token } });
      if(!res.ok){ if(res.status===403){ showToast('Acesso bloqueado para este conteúdo.', 'warn'); return; } showToast('Falha ao carregar PDF', 'warn'); return; }
      const buf = await res.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      let pageNum = 1; let scale = 1.2;
      const canvas = document.getElementById('pr-canvas');
      const ctx = canvas.getContext('2d');
      const lblPage = document.getElementById('pr-page');
      const lblZoom = document.getElementById('pr-zoom-label');
      async function render(){
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale });
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        // Marca d'água com e-mail
        try {
          ctx.save();
          ctx.globalAlpha = 0.25;
          ctx.fillStyle = 'rgba(255,255,255,0.85)';
          ctx.strokeStyle = 'rgba(0,0,0,0.25)';
          ctx.font = '20px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
          ctx.textAlign = 'center';
          ctx.translate(canvas.width/2, canvas.height/2);
          ctx.rotate(-Math.PI/6);
          const text = `Eros Vitta — ${currentUserEmail}`;
          const stepX = 320, stepY = 180;
          for(let y = -canvas.height; y <= canvas.height; y += stepY){
            for(let x = -canvas.width; x <= canvas.width; x += stepX){
              ctx.strokeText(text, x, y);
              ctx.fillText(text, x, y);
            }
          }
          ctx.restore();
        } catch {}
        lblPage.textContent = `Página ${pageNum} / ${pdf.numPages}`;
        lblZoom.textContent = Math.round(scale*100) + '%';
      }
      document.getElementById('pr-prev').onclick = async ()=>{ pageNum = Math.max(1, pageNum-1); await render(); };
      document.getElementById('pr-next').onclick = async ()=>{ pageNum = Math.min(pdf.numPages, pageNum+1); await render(); };
      document.getElementById('pr-zoom-in').onclick = async ()=>{ scale = Math.min(3.0, scale+0.1); await render(); };
      document.getElementById('pr-zoom-out').onclick = async ()=>{ scale = Math.max(0.6, scale-0.1); await render(); };
      await render();
    }

    function ensureAudioModal(){
      let modal = document.getElementById('audio-modal');
      if (modal) return modal;
      modal = document.createElement('div');
      modal.className = 'overlay';
      modal.id = 'audio-modal';
      modal.innerHTML = `
        <div class="overlay-inner">
          <div class="overlay-toolbar">
            <div class="overlay-actions">
              <button class="overlay-btn ghost" id="am-close">Fechar</button>
            </div>
            <div class="overlay-actions"><span class="small" id="am-title">Reprodutor</span></div>
          </div>
          <div class="overlay-canvas">
            <div style="width:100%;max-width:860px;">
              <audio id="am-audio" controls style="width:100%"></audio>
              <div class="progress" id="am-progress"><div class="bar" id="am-bar"></div></div>
              <div class="time" id="am-time"></div>
              <div id="am-list" class="small" style="margin-top:8px"></div>
            </div>
          </div>
          <div class="overlay-toolbar" style="justify-content:center"><span class="small">Álbum</span></div>
        </div>`;
      document.body.appendChild(modal);
      modal.querySelector('#am-close').addEventListener('click', ()=>{ modal.classList.remove('show'); showMiniPlayer(); });
      return modal;
    }

    function ensureMiniPlayer(){
      let mini = document.getElementById('mini-player');
      if (mini) return mini;
      mini = document.createElement('div');
      mini.id = 'mini-player';
      mini.style.position = 'fixed';
      mini.style.right = '16px';
      mini.style.bottom = '16px';
      mini.style.zIndex = '1001';
      mini.style.display = 'none';
      mini.style.background = '#111827';
      mini.style.color = '#fff';
      mini.style.borderRadius = '10px';
      mini.style.boxShadow = '0 6px 20px rgba(0,0,0,0.2)';
      mini.style.padding = '10px 12px';
      mini.innerHTML = '<div id="mini-title" style="font-size:13px; max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Reprodutor</div>' +
                       '<div id="mini-time" class="small" style="margin:4px 0 8px; opacity:.85">0:00 / 0:00</div>' +
                       '<div style="display:flex; gap:8px; align-items:center; justify-content:flex-end">' +
                       '  <button id="mini-toggle" class="btn" style="background:#111827">Reproduzir</button>' +
                       '  <button id="mini-open" class="btn" style="background:#10b981">Abrir</button>' +
                       '  <button id="mini-close" class="btn" style="background:#374151">Fechar</button>' +
                       '</div>';
      document.body.appendChild(mini);
      mini.querySelector('#mini-open').addEventListener('click', ()=>{ const m = document.getElementById('audio-modal'); if(m){ m.classList.add('show'); hideMiniPlayer(); }});
      mini.querySelector('#mini-toggle').addEventListener('click', ()=>{
        const a = document.getElementById('am-audio');
        if (!a) return;
        if (a.paused) { a.play().catch(()=>{}); } else { a.pause(); }
        updateMiniTime();
      });
      mini.querySelector('#mini-close').addEventListener('click', ()=> hideMiniPlayer());
      return mini;
    }

    function showMiniPlayer(){
      const mini = ensureMiniPlayer();
      const title = document.getElementById('am-title');
      const mt = document.getElementById('mini-title');
      if (mt && title) mt.textContent = title.textContent || 'Reprodutor';
      updateMiniTime();
      mini.style.display = 'block';
    }

    function hideMiniPlayer(){
      const mini = ensureMiniPlayer();
      mini.style.display = 'none';
    }

    function updateMiniTime(){
      const a = document.getElementById('am-audio');
      const mt = document.getElementById('mini-time');
      const toggle = document.getElementById('mini-toggle');
      if (!a || !mt || !toggle) return;
      const fmt = (s)=>{ const m = Math.floor(s/60), r = Math.floor(s%60); return `${m}:${String(r).padStart(2,'0')}`; };
      const cur = a.currentTime || 0;
      const dur = a.duration || 0;
      mt.textContent = `${fmt(cur)} / ${dur>0?fmt(dur):'0:00'}`;
      toggle.textContent = a.paused ? 'Reproduzir' : 'Pausar';
    }

    async function playAudio(produtoId, albumTitulo='Reprodutor de Áudio'){
      const token = getToken();
      let playlist;
      try {
        const j = await api(`/api/view/audio/playlist?produto_id=${encodeURIComponent(produtoId)}`);
        playlist = (j.items || j.data?.items || []);
      } catch(e){
        if(String(e.message||'').toLowerCase().includes('bloqueado')){ showToast('Acesso bloqueado para este conteúdo.', 'warn'); } else { showToast('Erro ao carregar playlist: ' + e.message, 'warn'); }
        return;
      }

      const modal = ensureAudioModal();
      modal.classList.add('show');
      hideMiniPlayer();
      const audio = document.getElementById('am-audio');
      const progress = document.getElementById('am-progress');
      const bar = document.getElementById('am-bar');
      const time = document.getElementById('am-time');
      const list = document.getElementById('am-list');
      const title = document.getElementById('am-title');
      title.textContent = albumTitulo;

      let idx = 0;
      function keyFor(trackId){ return `ev_audio_pos_${currentUserEmail}_${produtoId}_${trackId}`; }

      async function loadTrack(i, resume=false){
        if(i < 0 || i >= playlist.length){ return; }
        idx = i;
        const tr = playlist[idx];
        const url = `/api/view/audio/track?produto_id=${encodeURIComponent(produtoId)}&track_id=${encodeURIComponent(tr.id)}`;
        const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
        if(!res.ok){ if(res.status===403){ showToast('Acesso bloqueado para este conteúdo.', 'warn'); return; } showToast('Falha ao carregar faixa', 'warn'); return; }
        const blob = await res.blob();
        const obj = URL.createObjectURL(blob);
        audio.pause();
        audio.src = obj;
        audio.currentTime = 0; // garante início no zero por padrão
        const saved = resume ? parseFloat(localStorage.getItem(keyFor(tr.id)) || '0') : 0;
        audio.addEventListener('loadedmetadata', ()=>{
          if(!isNaN(saved) && saved > 0){ try { audio.currentTime = saved; } catch {} }
          audio.play().catch(()=>{});
        }, { once: true });
        renderList();
      }

      function renderList(){
        list.innerHTML = '';
        const toolbar = document.createElement('div');
        toolbar.className = 'actions';
        const prev = button('Anterior', ()=> loadTrack(idx-1, false));
        const next = button('Próxima', ()=> loadTrack(idx+1, false));
        toolbar.appendChild(prev); toolbar.appendChild(next);
        list.appendChild(toolbar);
        const ul = document.createElement('div');
        for(let i=0;i<playlist.length;i++){
          const tr = playlist[i];
          const item = document.createElement('div');
          item.style.padding = '6px 8px';
          item.style.border = '1px solid #e2e8f0';
          item.style.borderRadius = '6px';
          item.style.marginTop = '6px';
          item.style.cursor = 'pointer';
          const dur = (typeof tr.duracao_segundos === 'number' && tr.duracao_segundos > 0) ? ` (${formatDuration(tr.duracao_segundos)})` : '';
          item.textContent = `${String(tr.ordem||i+1).padStart(2,'0')} — ${tr.titulo}${dur}`;
          if(i === idx){ item.style.background = '#f1f5f9'; }
          item.onclick = ()=> loadTrack(i, true);
          ul.appendChild(item);
        }
        list.appendChild(ul);
      }

      function updateProgress(){
        const dur = audio.duration || 0;
        const cur = audio.currentTime || 0;
        const pct = dur > 0 ? (cur / dur * 100) : 0;
        bar.style.width = Math.max(0, Math.min(100, pct)) + '%';
        const left = dur > 0 ? Math.max(0, Math.round(dur - cur)) : 0;
        const fmt = (s)=>{ const m = Math.floor(s/60), r = s%60; return `${m}:${String(r).padStart(2,'0')}`; };
        time.textContent = (dur>0) ? `${fmt(Math.round(cur))} / ${fmt(Math.round(dur))}  (restante: ${fmt(left)})` : '';
        updateMiniTime();
      }

      progress.addEventListener('click', (e)=>{
        const rect = progress.getBoundingClientRect();
        const ratio = (e.clientX - rect.left) / rect.width;
        if (audio.duration && ratio>=0 && ratio<=1){ audio.currentTime = ratio * audio.duration; }
      });

      audio.addEventListener('timeupdate', ()=>{
        const tr = playlist[idx]; if(!tr) return;
        try { localStorage.setItem(keyFor(tr.id), String(audio.currentTime||0)); } catch {}
        updateProgress();
      });
      audio.addEventListener('ended', ()=>{ const tr = playlist[idx]; if(!tr) return; try { localStorage.removeItem(keyFor(tr.id)); } catch {}; loadTrack(idx+1, false); });
      audio.addEventListener('loadedmetadata', updateProgress);
      audio.addEventListener('seeked', updateProgress);

      if(playlist.length > 0){ loadTrack(0, true); } else { list.textContent = 'Nenhuma faixa disponível.'; }
    }

    async function doDownload(produtoId){
      try {
        const j = await api('/api/downloads/token', { method:'POST', body: JSON.stringify({ produto_id: produtoId }) });
        const t = j.data.token;
        window.location.href = `/api/downloads/file?token=${encodeURIComponent(t)}`;
      } catch(e){ showToast('Download indisponível: ' + e.message, 'warn'); }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    window.addEventListener('DOMContentLoaded', ()=>{
      const has = !!getToken();
      document.querySelector('#login').style.display = has ? 'none' : 'block';
      document.querySelector('#app').style.display = has ? 'block' : 'none';
      if(has){ loadUserProfile().finally(loadCatalog); }
      // Deep-link: ?reset=TOKEN ou ?token=TOKEN abre o modal de redefinição
      try{
        const usp = new URLSearchParams(location.search);
        const tk = usp.get('reset') || usp.get('token');
        if (tk) {
          openReset(tk);
          usp.delete('reset'); usp.delete('token');
          const newQs = usp.toString();
          const newUrl = location.pathname + (newQs ? ('?' + newQs) : '') + location.hash;
          history.replaceState(null, '', newUrl);
        }
      }catch{}
      // Bloqueios básicos (não infalíveis): clique direito e atalhos comuns
      window.addEventListener('contextmenu', e => {
        if (!e.target.closest('input, textarea')) e.preventDefault();
      });
      window.addEventListener('keydown', e => {
        const k = (e.key || '').toLowerCase();
        const ctrl = e.ctrlKey || e.metaKey;
        // bloquear F12, Ctrl+Shift+I/J/C/U, Ctrl+S, Ctrl+P
        if (k === 'f12') { e.preventDefault(); e.stopPropagation(); }
        if (ctrl && (k === 's' || k === 'p' || k === 'u')) { e.preventDefault(); e.stopPropagation(); }
        if ((e.ctrlKey && e.shiftKey) && (k === 'i' || k === 'j' || k === 'c')) { e.preventDefault(); e.stopPropagation(); }
      }, true);
    });
  </script>
  </head>

<body>
  <div id="toast" style="position: fixed; right: 16px; bottom: 16px; z-index: 2000; max-width: 360px; display:none;"><div class="tcard" id="toast-msg">...</div></div>
  <header>
    <div class="header-title">
      <i class="fas fa-book-open"></i>
      <strong>Eros Vitta Members</strong>
    </div>
    <div class="header-actions">
      <span class="muted">Olá, <strong id="userName"></strong></span>
      <div class="menu">
        <button id="avatarBtn" class="avatar" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-user"></i>
        </button>
        <div id="userMenu" class="menu-panel" role="menu">
          <button class="menu-item" onclick="loadAccesses(); toggleMenu(false)">
            <i class="fas fa-key"></i> Meus acessos
          </button>
          <button class="menu-item" onclick="openProfile(); toggleMenu(false)">
            <i class="fas fa-user-cog"></i> Perfil
          </button>
          <button class="menu-item" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Sair
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="layout">

    <div class="container-login">
      <section id="login" class="card auth-card" style="display:block">
        <div style="text-align:center; margin-bottom:12px;"><strong style="font-size:20px">Eros Vitta</strong></div>
        <div class="auth-title">Identifique-se</div>
        <div class="auth-subtitle">Digite seu e-mail e senha</div>
          <form onsubmit="login(event)">
            <div class="row">
              <div><label class="muted" for="email">E-mail</label><input id="email" class="input" type="email" placeholder="seu@email.com" autocomplete="email" required /></div>
              <div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <label class="muted" for="senha">Senha</label>
                  <a class="link" href="#" onclick="openForgot(); return false;">Esqueci minha senha</a>
                </div>
                <input id="senha" class="input" type="password" placeholder="sua senha" autocomplete="current-password" required />
              </div>
            </div>
            <div style="margin-top:14px"><button class="btn block" type="submit">Entrar</button></div>
          </form>
      </section>
    </div>

    <main class="container">
      <section id="app" style="display:none">
        <h2>Catálogo</h2>
        <div id="catalog" class="grid"></div>
      </section>
    </main>
  </div>

  <div id="pdfjs-modal" class="overlay">
    <div class="overlay-inner">
      <div class="overlay-toolbar"><div></div><div class="overlay-actions"><button class="overlay-btn ghost" onclick="document.getElementById('pdfjs-modal').classList.remove('show')">Fechar</button></div></div>
      <div class="overlay-canvas"><iframe id="pdfjs-frame" style="width:100%;height:100%;border:0;background:#fff"></iframe></div>
      <div class="overlay-toolbar" style="justify-content:center"><span class="small">Visualização PDF</span></div>
    </div>
  </div>

  <script>
    function openProfile(){
      let modal = document.getElementById('profile-modal');
      if(!modal){
        modal = document.createElement('div');
        modal.className = 'overlay';
        modal.id = 'profile-modal';
        modal.innerHTML = `
          <div class="overlay-inner">
            <div class="overlay-toolbar">
              <div class="overlay-actions"><button class="overlay-btn ghost" id="pf-close">Fechar</button></div>
              <div class="overlay-actions"><span class="small">Perfil</span></div>
            </div>
            <div class="overlay-canvas">
              <div class="card form-card">
                <h3 class="title">Trocar senha</h3>
                <div class="row">
                  <div><label class="muted" for="pf-old">Senha atual</label><input id="pf-old" class="input" type="password" autocomplete="current-password" required /></div>
                  <div><label class="muted" for="pf-new">Nova senha</label><input id="pf-new" class="input" type="password" autocomplete="new-password" required /></div>
                </div>
                <div class="form-actions">
                  <button class="btn secondary" id="pf-save">Salvar</button>
                </div>
                <div class="small" id="pf-msg" style="margin-top:8px"></div>
              </div>
            </div>
            <div class="overlay-toolbar" style="justify-content:center"><span class="small">Conta</span></div>
          </div>`;
        document.body.appendChild(modal);
        modal.querySelector('#pf-close').addEventListener('click', ()=> modal.classList.remove('show'));
        modal.querySelector('#pf-save').addEventListener('click', async ()=>{
          const senha_atual = (document.getElementById('pf-old').value||'');
          const senha_nova = (document.getElementById('pf-new').value||'');
          const msg = document.getElementById('pf-msg');
          msg.textContent = 'Enviando...';
          try{
            const res = await api('/api/auth/password/change', { method:'POST', body: JSON.stringify({ senha_atual, senha_nova }) });
            msg.textContent = 'Senha alterada com sucesso.';
            document.getElementById('pf-old').value = '';
            document.getElementById('pf-new').value = '';
          }catch(e){ msg.textContent = 'Falha: ' + e.message; }
        });
      }
      modal.classList.add('show');
    }
    function openPdfJs(produtoId){
      const token = getToken();
      const src = `/api/view/pdf-file?produto_id=${encodeURIComponent(produtoId)}`;
      const iframe = document.getElementById('pdfjs-frame');
      // Usa viewer nativo do navegador (iframe) com Authorization não suportado → solução: window.open com Bearer no header não é possível.
      // Alternativa: URL temporária com token de sessão no query (não ideal). Como estamos atrás de JWT no backend, usamos fetch+blob.
      fetch(src, { headers: { 'Authorization': 'Bearer ' + token } })
        .then(r => { if(!r.ok) throw new Error('Falha ao carregar PDF'); return r.blob(); })
        .then(b => {
          const url = URL.createObjectURL(b);
          iframe.src = url; // abre como blob (sem URL do arquivo)
          document.getElementById('pdfjs-modal').classList.add('show');
        })
        .catch(e => showToast(e.message, 'warn'));
    }
  </script>
  
  <script>
    // Verificar token na inicialização
    document.addEventListener('DOMContentLoaded', async function() {
      const token = getToken();
      if (token) {
        try {
          // Verificar se o token é válido
          await api('/api/auth/me');
          // Token válido - mostrar app e esconder login
          document.querySelector('#login').style.display = 'none';
          document.querySelector('#app').style.display = 'block';
          document.querySelector('header').style.display = 'flex';
          await loadUserProfile();
          await loadCatalog();
        } catch (e) {
          // Token inválido - limpar e mostrar login
          clearToken();
          document.querySelector('#login').style.display = 'block';
          document.querySelector('#app').style.display = 'none';
          document.querySelector('header').style.display = 'none';
        }
      } else {
        // Sem token - mostrar login
        document.querySelector('#login').style.display = 'block';
        document.querySelector('#app').style.display = 'none';
        document.querySelector('header').style.display = 'none';
      }
    });
  </script>
</body>
</html>


