<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Eros Vitta Members</title>
    <style>
      :root { color-scheme: light dark; --bg:#0b0b0c; --fg:#e9eaed; --muted:#9aa0a6; --card:#151517; --acc:#4f46e5; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
      * { box-sizing: border-box; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--fg); }
      header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background: var(--card); position: sticky; top:0; z-index:10; }
      header h1 { margin:0; font-size:16px; letter-spacing:.3px; }
      .container { padding: 16px; max-width: 1200px; margin: 0 auto; }
      .card { background: var(--card); border:1px solid #2a2b2f; border-radius: 10px; padding:16px; }
      .grid { display: grid; gap:12px; }
      .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      input, select, textarea { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #2a2b2f; background:#0e0f12; color:var(--fg); }
      textarea { min-height: 96px; resize: vertical; }
      label { font-size:12px; color: var(--muted); display:block; margin-bottom:6px; }
      button { padding:10px 14px; border-radius:8px; border:1px solid #2a2b2f; background:#16181d; color:var(--fg); cursor:pointer; }
      button.primary { background: var(--acc); border-color: var(--acc); }
      button.ghost { background: transparent; }
      button.danger { background: #211314; border-color:#3a1b1e; color:#ffb4b4; }
      table { width:100%; border-collapse: collapse; }
      th, td { border-bottom:1px solid #2a2b2f; padding:10px; text-align:left; vertical-align: top; }
      th { font-weight:600; font-size:12px; color: var(--muted); }
      .pill { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #2a2b2f; }
      .pill.ok { background:#0f2a21; color:#8be0c2; border-color:#173f31; }
      .pill.off { background:#2a1a1a; color:#ffc3c3; border-color:#3a1b1e; }
      .hidden { display:none !important; }
      .right { margin-left:auto; }
      .mt8 { margin-top: 8px; }
      .mt12 { margin-top: 12px; }
      .mt16 { margin-top: 16px; }
      .mt24 { margin-top: 24px; }
      .mb8 { margin-bottom: 8px; }
      .mb16 { margin-bottom: 16px; }
      .w-120 { width:120px; }
      .w-160 { width:160px; }
      .w-200 { width:200px; }
      .center { text-align:center; }
      .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; color:#b3c0ff; }
      a { color:#93c5fd; text-decoration:none; }
      a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <header>
      <h1>Admin - Eros Vitta Members</h1>
      <div class="row">
        <span id="whoami" class="code"></span>
        <button id="logoutBtn" class="ghost">Sair</button>
      </div>
    </header>
    <div class="container">
      <div id="loginCard" class="card">
        <h2 class="mb16">Login Admin</h2>
        <div class="grid grid-2">
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="admin@exemplo.com" />
          </div>
          <div>
            <label>Senha</label>
            <input id="senha" type="password" placeholder="••••••••" />
          </div>
        </div>
        <div class="row mt16">
          <button id="loginBtn" class="primary">Entrar</button>
          <span id="loginMsg" class="code"></span>
        </div>
      </div>

      <div id="app" class="hidden">
        <div class="row" style="margin-bottom:12px">
          <button id="tabProducts" class="primary">Produtos</button>
          <button id="tabUsers" class="ghost">Usuários</button>
        </div>
        <div id="viewProducts">
        <div class="card mb16">
          <div class="row">
            <strong>Produtos</strong>
            <div class="right row">
              <input id="q" class="w-200" placeholder="Buscar por título/slug" />
              <select id="tipoFilter" class="w-160">
                <option value="">Tipo (todos)</option>
                <option value="ebook">ebook</option>
                <option value="audio">audio</option>
              </select>
              <select id="ativoFilter" class="w-160">
                <option value="">Status (todos)</option>
                <option value="1">Ativo</option>
                <option value="0">Inativo</option>
              </select>
              <select id="orderProd" class="w-160">
                <option value="id:desc">Mais recentes</option>
                <option value="titulo:asc">Título (A→Z)</option>
                <option value="titulo:desc">Título (Z→A)</option>
                <option value="tipo:asc">Tipo</option>
              </select>
              <select id="limitProd" class="w-160">
                <option value="20">20 por página</option>
                <option value="50">50 por página</option>
                <option value="100">100 por página</option>
              </select>
              <button id="reloadBtn">Atualizar</button>
              <button id="newBtn" class="primary">Novo produto</button>
            </div>
          </div>
        </div>

        <div class="card mb16">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Tipo</th>
                <th>Slug</th>
                <th>Ativo</th>
                <th>PDF</th>
                <th>Áudio</th>
                <th class="right">Ações</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div class="row mt12">
            <button id="prevBtn">Anterior</button>
            <button id="nextBtn">Próxima</button>
            <span id="pageInfo" class="code"></span>
          </div>
        </div>

        <div id="formCard" class="card hidden">
          <h3 id="formTitle">Novo produto</h3>
          <div class="grid grid-3 mt12">
            <div>
              <label>Título</label>
              <input id="f_titulo" />
            </div>
            <div>
              <label>Tipo</label>
              <select id="f_tipo">
                <option value="ebook">ebook</option>
                <option value="audio">audio</option>
              </select>
            </div>
            <div>
              <label>Slug</label>
              <input id="f_slug" />
            </div>
          </div>

          <div class="grid grid-3 mt12">
            <div>
              <label>Capa URL</label>
              <input id="f_capa" />
            </div>
            <div>
              <label>Ativo</label>
              <select id="f_ativo">
                <option value="1">Sim</option>
                <option value="0">Não</option>
              </select>
            </div>
            <div>
              <label>Hotmart Product ID</label>
              <input id="f_hotmart" />
            </div>
          </div>

          <div class="grid grid-3 mt12">
            <div>
              <label>Checkout URL (prioritário)</label>
              <input id="f_checkout" placeholder="https://..." />
            </div>
          </div>

          <div class="grid grid-2 mt12">
            <div>
              <label>Descrição</label>
              <textarea id="f_desc"></textarea>
            </div>
            <div>
              <div>
                <label>PDF - storage_view_pdf</label>
                <input id="f_pdf_view" placeholder="/view/pdf?file=..." />
              </div>
              <div class="mt8">
                <label>Áudio - storage_view_audio_dir</label>
                <input id="f_audio_dir" placeholder="/view/audio/playlist?dir=..." />
              </div>
            </div>
          </div>

          <div class="row mt16">
            <button id="saveBtn" class="primary">Salvar</button>
            <button id="cancelBtn" class="ghost">Cancelar</button>
            <button id="deactBtn" class="danger hidden">Desativar</button>
            <span id="formMsg" class="code"></span>
          </div>
        </div>
        </div>

        <div id="viewUsers" class="hidden">
          <div class="card mb16">
            <div class="row">
              <strong>Usuários</strong>
              <div class="right row">
                <input id="u_q" class="w-200" placeholder="Buscar por email/nome" />
                <button id="u_reload">Buscar</button>
              </div>
            </div>
          </div>
          <div class="card mb16">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nome</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th class="right">Ações</th>
                </tr>
              </thead>
              <tbody id="u_tbody"></tbody>
            </table>
          </div>
          <div class="card hidden" id="u_detail">
            <div class="row"><strong id="u_title">Detalhes do usuário</strong></div>
            <div class="row mt12">
              <div class="w-200">
                <button id="u_block">Bloquear usuário</button>
                <button id="u_unblock">Desbloquear</button>
              </div>
              <div class="w-200">
                <input id="u_reset_pwd" placeholder="Nova senha" />
                <button id="u_do_reset">Resetar senha</button>
              </div>
            </div>
            <div class="mt12">
              <strong>Acessos</strong>
              <div id="u_accesses"></div>
            </div>
            <div class="mt12">
              <strong>Liberar produto</strong>
              <div class="row">
                <input id="u_prod_id" class="w-120" placeholder="produto_id" />
                <input id="u_data" class="w-200" placeholder="YYYY-MM-DD HH:MM:SS (opcional)" />
                <button id="u_assign">Liberar</button>
              </div>
              <div class="row mt8">
                <input id="u_block_pid" class="w-120" placeholder="produto_id" />
                <input id="u_motivo" class="w-200" placeholder="motivo (opcional)" />
                <button id="u_block_access">Bloquear acesso</button>
              </div>
            </div>
            <div class="small mt8" id="u_msg"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const apiBase = '/api';
      const els = {
        loginCard: document.getElementById('loginCard'),
        app: document.getElementById('app'),
        email: document.getElementById('email'),
        senha: document.getElementById('senha'),
        loginBtn: document.getElementById('loginBtn'),
        loginMsg: document.getElementById('loginMsg'),
        whoami: document.getElementById('whoami'),
        logoutBtn: document.getElementById('logoutBtn'),
        q: document.getElementById('q'),
        tipoFilter: document.getElementById('tipoFilter'),
        ativoFilter: document.getElementById('ativoFilter'),
        orderProd: document.getElementById('orderProd'),
        limitProd: document.getElementById('limitProd'),
        reloadBtn: document.getElementById('reloadBtn'),
        newBtn: document.getElementById('newBtn'),
        tbody: document.getElementById('tbody'),
        prevBtn: document.getElementById('prevBtn'),
        nextBtn: document.getElementById('nextBtn'),
        pageInfo: document.getElementById('pageInfo'),
        tabProducts: document.getElementById('tabProducts'),
        tabUsers: document.getElementById('tabUsers'),
        viewProducts: document.getElementById('viewProducts'),
        viewUsers: document.getElementById('viewUsers'),
        u: {
          q: document.getElementById('u_q'),
          reload: document.getElementById('u_reload'),
          tbody: document.getElementById('u_tbody'),
          detail: document.getElementById('u_detail'),
          title: document.getElementById('u_title'),
          block: document.getElementById('u_block'),
          unblock: document.getElementById('u_unblock'),
          resetPwd: document.getElementById('u_reset_pwd'),
          doReset: document.getElementById('u_do_reset'),
          accesses: document.getElementById('u_accesses'),
          prodId: document.getElementById('u_prod_id'),
          data: document.getElementById('u_data'),
          assign: document.getElementById('u_assign'),
          blockPid: document.getElementById('u_block_pid'),
          motivo: document.getElementById('u_motivo'),
          blockAccess: document.getElementById('u_block_access'),
          msg: document.getElementById('u_msg'),
        },
        formCard: document.getElementById('formCard'),
        formTitle: document.getElementById('formTitle'),
        f: {
          id: null,
          titulo: document.getElementById('f_titulo'),
          tipo: document.getElementById('f_tipo'),
          slug: document.getElementById('f_slug'),
          capa: document.getElementById('f_capa'),
          ativo: document.getElementById('f_ativo'),
          hotmart: document.getElementById('f_hotmart'),
          checkout: document.getElementById('f_checkout'),
          desc: document.getElementById('f_desc'),
          pdf_view: document.getElementById('f_pdf_view'),
          audio_dir: document.getElementById('f_audio_dir'),
        },
        saveBtn: document.getElementById('saveBtn'),
        cancelBtn: document.getElementById('cancelBtn'),
        deactBtn: document.getElementById('deactBtn'),
        formMsg: document.getElementById('formMsg'),
      };

      const state = { token: localStorage.getItem('adminToken') || '', limit: 20, offset: 0, totalKnown: 0, itemsById: {} };

      function setAuth(token){ state.token = token; if(token){ localStorage.setItem('adminToken', token); } else { localStorage.removeItem('adminToken'); } }
      function hdr(){ return state.token ? { 'Authorization': 'Bearer ' + state.token, 'Content-Type':'application/json' } : { 'Content-Type':'application/json' }; }
      function show(el, v){ el.classList.toggle('hidden', !v); }
      function msg(el, text){ el.textContent = text; }
      function clearTbody(){ els.tbody.innerHTML=''; }
      function pill(text, ok){ return `<span class="pill ${ok?'ok':'off'}">${text}</span>`; }

      async function login(){
        msg(els.loginMsg, '...');
        try{
          const r = await fetch(apiBase + '/admin/login', { method:'POST', headers: hdr(), body: JSON.stringify({ email: els.email.value.trim(), senha: els.senha.value }) });
          const j = await r.json();
          if(!r.ok){ throw new Error(j.error||'Falha no login'); }
          const token = (j && j.data && j.data.token) ? j.data.token : j.token;
          setAuth(token);
          msg(els.loginMsg, '');
          enterApp();
        }catch(e){ msg(els.loginMsg, 'Erro: ' + e.message); }
      }

      function enterApp(){
        show(els.loginCard, false);
        show(els.app, true);
        els.whoami.textContent = 'admin';
        show(els.viewProducts, true);
        show(els.viewUsers, false);
        loadList();
      }
      function switchTab(tab){
        const isUsers = tab === 'users';
        show(els.viewProducts, !isUsers);
        show(els.viewUsers, isUsers);
        els.tabProducts.classList.toggle('primary', !isUsers);
        els.tabProducts.classList.toggle('ghost', isUsers);
        els.tabUsers.classList.toggle('primary', isUsers);
        els.tabUsers.classList.toggle('ghost', !isUsers);
        if(isUsers){ loadUsers(); }
      }

      async function loadUsers(){
        els.u.tbody.innerHTML = '<tr><td colspan="5" class="muted">Carregando...</td></tr>';
        try{
          const qs = new URLSearchParams();
          const q = (els.u.q.value||'').trim();
          if(q) qs.set('q', q);
          const usp = new URLSearchParams(location.hash.replace(/^#/,''));
          const uOrder = usp.get('u_order') || 'id:desc';
          const parts = uOrder.split(':');
          qs.set('order', parts[0]||'id');
          qs.set('dir', parts[1]||'desc');
          qs.set('limit', '20');
          qs.set('offset', String(state.offset||0));
          const r = await fetch('/api/admin/users?' + qs.toString(), { headers: hdr() });
          const j = await r.json();
          if(!r.ok){ throw new Error(j.error||'Erro ao listar usuários'); }
          const items = (j.data && Array.isArray(j.data.items)) ? j.data.items : (j.items||[]);
          els.u.tbody.innerHTML = items.map(u => `<tr>
            <td>${u.id}</td>
            <td>${u.nome||''}</td>
            <td><span class="code">${u.email||''}</span></td>
            <td>${u.status||''}</td>
            <td class="right"><button data-u-open="${u.id}">Abrir</button></td>
          </tr>`).join('');
          // pager
          let pager = document.getElementById('u_pager');
          if(!pager){
            pager = document.createElement('div');
            pager.id = 'u_pager';
            pager.className = 'row mt12';
            els.viewUsers.appendChild(pager);
          }
          pager.innerHTML = '';
          const prev = document.createElement('button'); prev.textContent = 'Anterior'; prev.onclick = ()=>{ state.offset=Math.max(0,(state.offset||0)-20); loadUsers(); };
          const next = document.createElement('button'); next.textContent = 'Próxima'; next.onclick = ()=>{ state.offset=(state.offset||0)+20; loadUsers(); };
          const orderSel = document.createElement('select');
          orderSel.innerHTML = '<option value="id:desc">Mais recentes</option><option value="nome:asc">Nome (A→Z)</option><option value="email:asc">Email (A→Z)</option><option value="status:asc">Status</option>';
          orderSel.value = (qs.get('order')+':'+qs.get('dir')) || 'id:desc';
          orderSel.addEventListener('change', ()=>{
            const v = orderSel.value; const usp2 = new URLSearchParams(location.hash.replace(/^#/,'')); usp2.set('u_order', v); location.hash = usp2.toString(); state.offset=0; loadUsers();
          });
          const info = document.createElement('span'); info.className='code'; info.textContent = `offset ${state.offset||0} • carregados ${items.length}`;
          pager.appendChild(orderSel); pager.appendChild(prev); pager.appendChild(next); pager.appendChild(info);
        }catch(e){ els.u.tbody.innerHTML = `<tr><td colspan="5" class="muted">Erro: ${e.message}</td></tr>`; }
      }

      async function openUser(userId){
        els.u.detail.classList.remove('hidden');
        els.u.title.textContent = `Usuário #${userId}`;
        // carrega acessos
        els.u.accesses.innerHTML = 'Carregando acessos...';
        try{
          const r = await fetch(`/api/admin/accesses/by-user?usuario_id=${encodeURIComponent(userId)}`, { headers: hdr() });
          const j = await r.json();
          if(!r.ok){ throw new Error(j.error||'Erro'); }
          const items = (j.data && Array.isArray(j.data.items)) ? j.data.items : (j.items||[]);
          els.u.accesses.innerHTML = items.length ? '' : '<div class="muted">Nenhum acesso.</div>';
          for(const a of items){
            const div = document.createElement('div');
            div.className = 'row';
            const label = document.createElement('div');
            label.textContent = `${a.titulo} (${a.tipo})`;
            const right = document.createElement('div');
            right.className = 'right';
            const sel = document.createElement('select');
            sel.innerHTML = '<option value="ativo">Ativo</option><option value="bloqueado">Bloqueado</option>';
            sel.value = a.status === 'ativo' ? 'ativo' : 'bloqueado';
            sel.addEventListener('change', async ()=>{
              try{
                const body = { usuario_id: userId, produto_id: a.produto_id, status: sel.value };
                const rr = await fetch('/api/admin/accesses/update-status', { method:'POST', headers: hdr(), body: JSON.stringify(body) });
                const jj = await rr.json();
                if(!rr.ok){ throw new Error(jj.error||'Erro'); }
                els.u.msg.textContent = 'Status atualizado.';
                // Recarrega a lista de acessos para refletir exatamente o que está no banco
                await openUser(userId);
              }catch(e){ els.u.msg.textContent = 'Erro: ' + e.message; sel.value = a.status; }
            });
            right.appendChild(sel);
            div.appendChild(label);
            div.appendChild(right);
            els.u.accesses.appendChild(div);
          }
          els.u.block.onclick = async ()=>{ try{ const rr = await fetch('/api/admin/users/block', { method:'POST', headers: hdr(), body: JSON.stringify({ id: userId }) }); const jj = await rr.json(); if(!rr.ok) throw new Error(jj.error||'Erro'); els.u.msg.textContent='Usuário bloqueado.'; loadUsers(); }catch(e){ els.u.msg.textContent='Erro: '+e.message; } };
          els.u.unblock.onclick = async ()=>{ try{ const rr = await fetch('/api/admin/users/unblock', { method:'POST', headers: hdr(), body: JSON.stringify({ id: userId }) }); const jj = await rr.json(); if(!rr.ok) throw new Error(jj.error||'Erro'); els.u.msg.textContent='Usuário desbloqueado.'; loadUsers(); }catch(e){ els.u.msg.textContent='Erro: '+e.message; } };
          els.u.doReset.onclick = async ()=>{ const senha = els.u.resetPwd.value; if(!senha){ els.u.msg.textContent='Informe a nova senha.'; return; } try{ const rr = await fetch('/api/admin/users/reset-password', { method:'POST', headers: hdr(), body: JSON.stringify({ id: userId, senha }) }); const jj = await rr.json(); if(!rr.ok) throw new Error(jj.error||'Erro'); els.u.msg.textContent='Senha redefinida.'; }catch(e){ els.u.msg.textContent='Erro: '+e.message; } };
          els.u.assign.onclick = async ()=>{ const pid = parseInt(els.u.prodId.value,10)||0; const data = (els.u.data.value||'').trim(); if(!pid){ els.u.msg.textContent='Informe produto_id'; return; } try{ const rr = await fetch('/api/admin/accesses/assign', { method:'POST', headers: hdr(), body: JSON.stringify({ usuario_id: userId, produto_id: pid, data_liberacao: data||undefined }) }); const jj = await rr.json(); if(!rr.ok) throw new Error(jj.error||'Erro'); els.u.msg.textContent='Acesso liberado.'; openUser(userId); }catch(e){ els.u.msg.textContent='Erro: '+e.message; } };
          els.u.blockAccess.onclick = async ()=>{ const pid = parseInt(els.u.blockPid.value,10)||0; const motivo = (els.u.motivo.value||'').trim(); if(!pid){ els.u.msg.textContent='Informe produto_id'; return; } try{ const rr = await fetch('/api/admin/accesses/block', { method:'POST', headers: hdr(), body: JSON.stringify({ usuario_id: userId, produto_id: pid, motivo }) }); const jj = await rr.json(); if(!rr.ok) throw new Error(jj.error||'Erro'); els.u.msg.textContent='Acesso bloqueado.'; openUser(userId); }catch(e){ els.u.msg.textContent='Erro: '+e.message; } };
        }catch(e){ els.u.accesses.innerHTML = 'Erro: ' + e.message; }
      }

      function exitApp(){ setAuth(''); show(els.app, false); show(els.loginCard, true); els.whoami.textContent=''; }

      function buildQuery(){
        const p = new URLSearchParams();
        if(els.q.value.trim()) p.set('q', els.q.value.trim());
        if(els.tipoFilter.value) p.set('tipo', els.tipoFilter.value);
        if(els.ativoFilter.value !== '') p.set('ativo', els.ativoFilter.value);
        const ord = (els.orderProd.value||'id:desc').split(':');
        p.set('order', ord[0]||'id');
        p.set('dir', (ord[1]||'desc'));
        const lim = parseInt(els.limitProd.value||'20',10); state.limit = lim>0?lim:20;
        p.set('limit', String(state.limit));
        p.set('offset', String(state.offset));
        p.set('_ts', String(Date.now()));
        return p.toString();
      }

      async function loadList(){
        clearTbody();
        msg(els.pageInfo, 'carregando...');
        try{
          const r = await fetch(apiBase + '/admin/products?' + buildQuery(), { headers: hdr(), cache: 'no-store' });
          const j = await r.json();
          if(!r.ok){ throw new Error((j && j.error) || 'Erro ao listar'); }
          const items = (j && j.data && Array.isArray(j.data.items)) ? j.data.items : (j.items || []);
          state.itemsById = {};
          for (const it of items) { if (it && typeof it.id !== 'undefined') { state.itemsById[it.id] = it; } }
          const playlistUrl = (id) => `/api/admin/view/audio/playlist?produto_id=${encodeURIComponent(id)}`;
          const trackUrl = (id, trackId) => `/api/admin/view/audio/track?produto_id=${encodeURIComponent(id)}&track_id=${encodeURIComponent(trackId)}`;
          els.tbody.innerHTML = items.map(row => {
            const hasPdf = !!(row.storage_view_pdf || row.storage_path_pdf);
            const hasAudioFile = !!row.storage_path_audio;
            const hasAudioDir = !!row.storage_view_audio_dir;
            const pdf = hasPdf ? `<a href="#" data-pdf="${row.id}">ver</a>` : '';
            const aud = hasAudioDir ? `<a href="#" data-audio="${row.id}">abrir</a>` : (hasAudioFile ? `<a href="#" data-audio-file="${row.id}">abrir</a>` : '');
            return `<tr>
              <td>${row.id}</td>
              <td>${row.titulo||''}</td>
              <td>${row.tipo||''}</td>
              <td><span class="code">${row.slug||''}</span></td>
              <td>${row.ativo==1?pill('ativo', true):pill('inativo', false)}</td>
              <td>${pdf}</td>
              <td>${aud}</td>
              <td class="right">
                <button data-edit="${row.id}">Editar</button>
              </td>
            </tr>`;
          }).join('');
          els.pageInfo.textContent = `offset ${state.offset} • carregados ${items.length}`;
        }catch(e){ els.pageInfo.textContent = 'Erro: ' + e.message; }
      }

      function openForm(row){
        els.formTitle.textContent = row && row.id ? `Editar #${row.id}` : 'Novo produto';
        els.f.id = row && row.id ? row.id : null;
        els.f.titulo.value = row?.titulo||'';
        els.f.tipo.value = row?.tipo||'ebook';
        els.f.slug.value = row?.slug||'';
        els.f.capa.value = row?.capa_url||'';
        els.f.ativo.value = String(row?.ativo ?? 1);
        els.f.hotmart.value = row?.hotmart_product_id||'';
        els.f.checkout.value = row?.checkout_url||'';
        els.f.desc.value = row?.descricao||'';
        els.f.pdf_view.value = row?.storage_view_pdf||row?.storage_path_pdf||'';
        els.f.audio_dir.value = row?.storage_view_audio_dir||row?.storage_path_audio||'';
        show(els.formCard, true);
        els.deactBtn.classList.toggle('hidden', !(row && row.id));
      }

      async function saveForm(){
        const payload = {
          titulo: els.f.titulo.value.trim(),
          tipo: els.f.tipo.value,
          slug: els.f.slug.value.trim(),
          descricao: els.f.desc.value,
          capa_url: els.f.capa.value.trim(),
          ativo: parseInt(els.f.ativo.value,10),
          hotmart_product_id: els.f.hotmart.value.trim(),
          checkout_url: els.f.checkout.value.trim(),
          storage_view_pdf: els.f.pdf_view.value.trim(),
          storage_view_audio_dir: els.f.audio_dir.value.trim(),
        };
        const isEdit = !!els.f.id;
        if(isEdit){ payload.id = els.f.id; }
        msg(els.formMsg, 'salvando...');
        try{
          const url = isEdit ? apiBase + '/admin/products/update' : apiBase + '/admin/products';
          const method = 'POST';
          const r = await fetch(url, { method, headers: hdr(), body: JSON.stringify(payload) });
          const j = await r.json();
          if(!r.ok){ throw new Error((j && j.error) || 'Erro ao salvar'); }
          msg(els.formMsg, 'OK');
          show(els.formCard, false);
          // Força atualização imediata
          state.offset = 0;
          await loadList();
        }catch(e){ msg(els.formMsg, 'Erro: ' + e.message); }
      }

      async function deactivate(){
        if(!els.f.id) return;
        if(!confirm('Desativar produto #' + els.f.id + '?')) return;
        msg(els.formMsg, 'desativando...');
        try{
          const r = await fetch(apiBase + '/admin/products/deactivate', { method:'POST', headers: hdr(), body: JSON.stringify({ id: els.f.id }) });
          const j = await r.json();
          if(!r.ok){ throw new Error((j && j.error) || 'Erro ao desativar'); }
          msg(els.formMsg, 'Desativado');
          show(els.formCard, false);
          loadList();
        }catch(e){ msg(els.formMsg, 'Erro: ' + e.message); }
      }

      function openBlobInNewTab(blob, mime){
        try{
          const url = URL.createObjectURL(new Blob([blob], { type: mime||'application/octet-stream' }));
          const w = window.open(url, '_blank', 'noopener');
          // URL será liberada quando a aba for fechada pelo navegador
        }catch(e){ alert('Falha ao abrir arquivo'); }
      }

      async function onTableClick(ev){
        const btn = ev.target.closest('button[data-edit]');
        if(btn){
          const id = parseInt(btn.getAttribute('data-edit'),10);
          const row = state.itemsById[id] || (function(){
            const tr = btn.closest('tr');
            return {
              id,
              titulo: tr.children[1].textContent,
              tipo: tr.children[2].textContent,
              slug: tr.children[3].textContent,
              ativo: (tr.children[4].querySelector('.pill')?.classList.contains('ok')) ? 1 : 0,
            };
          })();
          openForm(row);
          return;
        }
        const aPdf = ev.target.closest('a[data-pdf]');
        if(aPdf){
          ev.preventDefault();
          const produtoId = parseInt(aPdf.getAttribute('data-pdf'),10);
          try{
            const r = await fetch(`/api/admin/view/pdf-file?produto_id=${encodeURIComponent(produtoId)}`, { headers: hdr() });
            if(!r.ok){ const j=await r.json().catch(()=>({})); throw new Error(j.error||'Falha ao abrir PDF'); }
            const blob = await r.blob();
            openBlobInNewTab(blob, 'application/pdf');
          }catch(e){ alert('Erro ao abrir PDF: ' + e.message); }
          return;
        }
        const aAudio = ev.target.closest('a[data-audio]');
        if(aAudio){
          ev.preventDefault();
          const produtoId = parseInt(aAudio.getAttribute('data-audio'),10);
          try {
            const r = await fetch(`/api/admin/view/audio/playlist?produto_id=${encodeURIComponent(produtoId)}`, { headers: hdr() });
            const j = await r.json();
            const items = (j && j.data && Array.isArray(j.data.items)) ? j.data.items : (j.items || []);
            if(items.length === 0){ alert('Nenhuma faixa disponível.'); return; }
            const first = items[0];
            const t = await fetch(`/api/admin/view/audio/track?produto_id=${encodeURIComponent(produtoId)}&track_id=${encodeURIComponent(first.id)}`, { headers: hdr() });
            if(!t.ok){ const tj=await t.json().catch(()=>({})); throw new Error(tj.error||'Falha ao abrir áudio'); }
            const blob = await t.blob();
            openBlobInNewTab(blob, 'audio/mpeg');
          } catch(e){ alert('Erro ao abrir áudio: ' + e.message); }
          return;
        }
        const aAudioFile = ev.target.closest('a[data-audio-file]');
        if(aAudioFile){
          ev.preventDefault();
          const produtoId = parseInt(aAudioFile.getAttribute('data-audio-file'),10);
          try {
            const r = await fetch(`/api/admin/view/audio/file?produto_id=${encodeURIComponent(produtoId)}`, { headers: hdr() });
            if(!r.ok){ const j=await r.json().catch(()=>({})); throw new Error(j.error||'Falha ao abrir áudio'); }
            const blob = await r.blob();
            openBlobInNewTab(blob, 'audio/mpeg');
          } catch(e){ alert('Erro ao abrir áudio: ' + e.message); }
        }
      }

      // Eventos
      els.loginBtn.addEventListener('click', login);
      els.logoutBtn.addEventListener('click', exitApp);
      els.tabProducts.addEventListener('click', ()=> switchTab('products'));
      els.tabUsers.addEventListener('click', ()=> switchTab('users'));
      els.reloadBtn.addEventListener('click', () => { state.offset = 0; loadList(); });
      els.orderProd.addEventListener('change', () => { state.offset = 0; loadList(); });
      els.limitProd.addEventListener('change', () => { state.offset = 0; loadList(); });
      els.newBtn.addEventListener('click', () => openForm(null));
      els.tbody.addEventListener('click', onTableClick);
      els.u.reload.addEventListener('click', ()=>{ state.offset=0; loadUsers(); });
      els.u.tbody.addEventListener('click', (ev)=>{
        const b = ev.target.closest('button[data-u-open]');
        if(b){ const id = parseInt(b.getAttribute('data-u-open'),10); openUser(id); }
      });
      els.prevBtn.addEventListener('click', () => { state.offset = Math.max(0, state.offset - state.limit); loadList(); });
      els.nextBtn.addEventListener('click', () => { state.offset += state.limit; loadList(); });
      els.saveBtn.addEventListener('click', saveForm);
      els.cancelBtn.addEventListener('click', () => show(els.formCard, false));
      els.deactBtn.addEventListener('click', deactivate);

      // Auto-login se já tem token
      if(state.token){ enterApp(); } else { show(els.loginCard, true); }
    </script>
  </body>
  </html>


